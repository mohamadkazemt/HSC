{% extends 'base.html' %}
{% block content %}
{% load static %}

<div id="kt_app_root" class="d-flex flex-column flex-root app-root">
    <div id="kt_app_page" class="app-page flex-column flex-column-fluid">
        {% include 'header.html' %}

        <div id="kt_app_wrapper" class="app-wrapper flex-column flex-row-fluid">
            {% include 'sidebar.html' %}

            <div id="kt_app_main" class="app-main flex-column flex-row-fluid">
                <div class="d-flex flex-column flex-column-fluid">
                    {% include 'toolbar.html' %}

                    <div id="kt_app_content" class="app-content flex-column-fluid">
                        <div id="kt_app_content_container" class="app-container container-fluid">
                            <!-- Header Card -->
                            <div class="card card-flush mb-6">
                                <div class="card-header pt-5">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold fs-3 mb-1">گزارش شیفت شماره ({{ operation.id }})</span>
                                        <span class="text-muted mt-1 fw-semibold fs-7">جزئیات کامل گزارش عملیات</span>
                                    </h3>
                                </div>

                                <div class="card-body pt-0">
                                    <div class="d-flex flex-wrap gap-5">
                                        <!-- Basic Info -->
                                        <div class="border border-gray-300 border-dashed rounded min-w-125px py-3 px-4 me-2 mb-3">
                                            <div class="fs-6 text-gray-800 fw-bold">نوع سنگ:</div>
                                            <div class="fs-7 text-gray-600">{{ operation.get_stone_type_display }}</div>
                                        </div>

                                        <div class="border border-gray-300 border-dashed rounded min-w-125px py-3 px-4 me-2 mb-3">
                                            <div class="fs-6 text-gray-800 fw-bold">تعداد بار:</div>
                                            <div class="fs-7 text-gray-600">{{ operation.sumloded }}</div>
                                        </div>

                                        <div class="border border-gray-300 border-dashed rounded min-w-125px py-3 px-4 me-2 mb-3">
                                            <div class="fs-6 text-gray-800 fw-bold">گروه کاری:</div>
                                            <div class="fs-7 text-gray-600">{{ operation.group }}</div>
                                        </div>

                                        <div class="border border-gray-300 border-dashed rounded min-w-125px py-3 px-4 me-2 mb-3">
                                            <div class="fs-6 text-gray-800 fw-bold">نوع شیفت:</div>
                                            <div class="fs-7 text-gray-600">{{ operation.shift_type }}</div>
                                        </div>

                                        <div class="border border-gray-300 border-dashed rounded min-w-125px py-3 px-4 me-2 mb-3">
                                            <div class="fs-6 text-gray-800 fw-bold">تاریخ:</div>
                                            <div class="fs-7 text-gray-600">{{ operation.jalali_date }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Supervisor Report -->
                            <div class="card card-flush mb-6">
                                <div class="card-header">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold fs-3 mb-1">گزارش سرشیفت</span>
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="fw-semibold text-gray-600">{{ operation.supervisor_comments }}</div>
                                </div>
                            </div>

                            <div class="row g-5 g-xl-8">
                                <!-- Loaders Status -->
                                <div class="col-xl-6">
                                    <div class="card card-flush h-xl-100">
                                        <div class="card-header">
                                            <h3 class="card-title align-items-start flex-column">
                                                <span class="card-label fw-bold fs-3 mb-1">وضعیت بارکننده‌ها</span>
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                                    <thead>
                                                        <tr class="fw-bold text-muted">
                                                            <th>نام بارکننده</th>
                                                            <th>بلوک</th>
                                                            <th>وضعیت</th>
                                                            <th>دلیل توقف</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for status in operation.loader_statuses.all %}
                                                        <tr>
                                                            <td>{{ status.loader.machine_name }}</td>
                                                            <td>{{ status.block.block_name }}</td>
                                                            <td>
                                                                {% if status.status == 'active' %}
                                                                <span class="badge badge-success">فعال</span>
                                                                {% else %}
                                                                <span class="badge badge-danger">غیرفعال</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ status.inactive_reason|default:"-" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shift Leaves -->
                                <div class="col-xl-6">
                                    <div class="card card-flush h-xl-100">
                                        <div class="card-header">
                                            <h3 class="card-title align-items-start flex-column">
                                                <span class="card-label fw-bold fs-3 mb-1">مرخصی‌های شیفت</span>
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                                    <thead>
                                                        <tr class="fw-bold text-muted">
                                                            <th>نام پرسنل</th>
                                                            <th>کد پرسنلی</th>
                                                            <th>وضعیت مرخصی</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for leave in operation.shift_leaves.all %}
                                                        <tr>
                                                            <td>{{ leave.personnel_name.user.get_full_name }}</td>
                                                            <td>{{ leave.personnel_name.personnel_code }}</td>
                                                            <td>
                                                                {% if leave.leave_status == 'authorized' %}
                                                                <span class="badge badge-success">مجاز</span>
                                                                {% else %}
                                                                <span class="badge badge-danger">غیرمجاز</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vehicles -->
                            <div class="card card-flush mt-6">
                                <div class="card-header">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold fs-3 mb-1">خودروهای پیمانکاران</span>
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                            <thead>
                                                <tr class="fw-bold text-muted">
                                                    <th>نام خودرو</th>
                                                    <th>وضعیت</th>
                                                    <th>زمان شروع توقف</th>
                                                    <th>زمان پایان توقف</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for vehicle in operation.vehicle_reports.all %}
                                                <tr>
                                                    <td>{{ vehicle.vehicle_name }}</td>
                                                    <td>
                                                        {% if vehicle.is_active %}
                                                        <span class="badge badge-success">فعال</span>
                                                        {% else %}
                                                        <span class="badge badge-danger">غیرفعال</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ vehicle.inactive_time_start|default:"-" }}</td>
                                                    <td>{{ vehicle.inactive_time_end|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Creator Info -->
                            <div class="card card-flush mt-6">
                                <div class="card-header">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold fs-3 mb-1">اطلاعات ثبت کننده</span>
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        {% if operation.creator.image %}
                                        <div class="symbol symbol-50px me-5">
                                            <img src="{{ operation.creator.image.url }}" alt="" />
                                        </div>
                                        {% endif %}
                                        <div class="d-flex flex-column">
                                            <span class="text-gray-800 fs-5 fw-bold">{{ operation.creator.user.get_full_name }}</span>
                                            <span class="text-gray-600">کد پرسنلی: {{ operation.creator.personnel_code }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                {% include 'footer.html' %}
            </div>
        </div>
    </div>
</div>

{% endblock %}