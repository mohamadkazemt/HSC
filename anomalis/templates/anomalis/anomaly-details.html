{% extends 'base.html' %}
{% block content %}
    {% load static %}
    {% load jalali %}
    <!--begin::اپلیکیشن-->
    <div class="d-flex flex-column flex-root app-root" id="kt_app_root">
        <!--begin::Page-->
        <div class="app-page flex-column flex-column-fluid" id="kt_app_page">
            <!--begin::Header-->
            {% include 'header.html' %}
            <!--end::Header-->
            <!--begin::Wrapper-->
            <div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
                <!--begin::Sidebar-->

                {% include 'sidebar.html' %}
                <!--end::Sidebar-->
                <!--begin::اصلی-->
                <div class="app-main flex-column flex-row-fluid" id="kt_app_main">
                    <!--begin::Content wrapper-->
                    <div class="d-flex flex-column flex-column-fluid">
                        <!--begin::Toolbar-->
                        {% include 'toolbar.html' %}
                        <!--end::Toolbar-->
                        <!--begin::Content-->
                        <div id="kt_app_content" class="app-content flex-column-fluid">
                            <!--begin::Content container-->
                            <div id="kt_app_content_container" class="app-container container-fluid">
                                <!--begin::سوشیال - تغذیه -->
                                <div class="d-flex flex-row">

                                    <!--begin::Content-->
                                    <div class="w-100 flex-lg-row-fluid mx-lg-13">
                                        <!--begin::Mobile toolbar-->
                                        <div class="d-flex d-lg-none align-items-center justify-content-end mb-10">
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="btn btn-icon btn-active-color-primary w-30px h-30px" id="kt_social_start_sidebar_toggle">
                                                    <i class="ki-outline ki-profile-circle fs-1"></i>
                                                </div>
                                                <div class="btn btn-icon btn-active-color-primary w-30px h-30px" id="kt_social_end_sidebar_toggle">
                                                    <i class="ki-outline ki-scroll fs-1"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <!--end::Mobile toolbar-->
                                        <!--begin::اصلی form-->
                                        <!--end::اصلی form-->
                                        <!--begin::Posts-->
                                        <div class="mb-10" id="kt_social_feeds_posts">
                                            <!--begin::Post 1-->
                                            <!--begin::کارت-->
                                            <div class="card card-flush mb-10">
                                                <!--begin::کارت header-->
                                                <div class="card-header pt-9">
                                                    <!--begin::نویسنده-->
                                                    <div class="d-flex align-items-center">
                                                        <!--begin::Avatar-->
                                                        {% if anomaly.followup.image %}
                                                            <div class="symbol symbol-50px me-5">
                                                                <img src="{{ anomaly.followup.image.url }}" class="" alt="" />
                                                            </div>
                                                        {% else %}
                                                            <div class="symbol symbol-50px me-5">
                                                                <img src="{% static 'assets/media/avatars/blank.png' %}" class="" alt="" />
                                                            </div>
                                                        {% endif %}
                                                        <!--end::Avatar-->
                                                        <!--begin::Info-->
                                                        <div class="flex-grow-1">
                                                            <!--begin::نام-->
                                                            <a href="#" class="text-gray-800 text-hover-primary fs-4 fw-bold">  آنومالی شماره: ({{ anomaly.id }})    {{ anomaly.anomalydescription }} </a>
                                                            <!--end::نام-->
                                                            <!--begin::تاریخ-->
                                                            <div class="d-flex flex-wrap fw-semibold fs-6 mb-4 pe-2">
                                                                <!-- محل آنومالی -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-map-marker-alt fs-4 me-1"></i> محل آنومالی: {{ anomaly.location }}
                                                                </a>

                                                                <!-- نوع آنومالی -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-exclamation-triangle fs-4 me-1"></i> نوع آنومالی: {{ anomaly.anomalytype }}
                                                                </a>

                                                                <!-- نوع HSE -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-shield-alt fs-4 me-1"></i> HSE:
                                                                    {% if anomaly.hse_type == 'H' %}
                                                                        Health
                                                                    {% elif anomaly.hse_type == 'S' %}
                                                                        Safety
                                                                    {% elif anomaly.hse_type == 'E' %}
                                                                        Environment
                                                                    {% endif %}
                                                                </a>

                                                                <!-- عملیات اصلاحی -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-tools fs-4 me-1"></i> عملیات اصلاحی: {{ anomaly.correctiveaction }}
                                                                </a>

                                                                <!-- ایجاد کننده -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-user fs-4 me-1"></i> ایجاد کننده: {{ anomaly.created_by.user.first_name }} {{ anomaly.created_by.user.last_name }}
                                                                </a>

                                                                <!-- پیگیری -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-user-check fs-4 me-1"></i> پیگیری: {{ anomaly.followup.user.first_name }} {{ anomaly.followup.user.last_name }}
                                                                </a>

                                                                <!-- گروه کاری -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-users fs-4 me-1"></i> گروه کاری: {{ anomaly.get_group_display }}
                                                                </a>

                                                                <!-- اولویت -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-flag fs-4 me-1"></i> اولویت: {{ anomaly.priority }}
                                                                </a>

                                                                <!-- وضعیت عملیات -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-check-circle fs-4 me-1"></i> وضعیت:
                                                                    {% if anomaly.action %}
                                                                        ایمن
                                                                    {% else %}
                                                                        غیر ایمن
                                                                    {% endif %}
                                                                </a>

                                                                <!-- تاریخ ایجاد -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-calendar-alt fs-4 me-1"></i> تاریخ ایجاد: {{ anomaly.created_at|to_jalali }}
                                                                </a>

                                                                <!-- تاریخ بروزرسانی -->
                                                                <a href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2">
                                                                    <i class="fas fa-sync-alt fs-4 me-1"></i> تاریخ بروزرسانی: {{ anomaly.updated_at|to_jalali }}
                                                                </a>

                                                                <!-- تصویر آنومالی -->
                                                                {% if anomaly.image %}
                                                                    <a href="{{ anomaly.image.url }}" class="d-flex align-items-center text-gray-500 text-hover-primary mb-2">
                                                                        <i class="fas fa-image fs-4 me-1"></i> مشاهده تصویر
                                                                    </a>
                                                                {% endif %}



                                                            </div>


                                                            <!--end::تاریخ-->
                                                        </div>
                                                        <!--end::Info-->
                                                    </div>
                                                    <!--end::نویسنده-->

                                                </div>
                                                <!--end::کارت header-->
                                                <!--begin::کارت body-->
                                                <div class="card-body">
                                                    <!--begin::Post content-->
                                                    <div class="fs-6 fw-normal text-gray-700 mb-5">{{ anomaly.description }}</div>
                                                    <!--end::Post content-->


                                                    <div class="card-footer pt-0">
                                                        <!--begin::Info-->
                                                        <div class="mb-6">
                                                            <!--begin::separator-->
                                                            <div class="separator separator-solid"></div>
                                                            <!--end::separator-->
                                                            <!--begin::Nav-->
<div class="card-header d-flex justify-content-between align-items-center">

    <a href="{% url 'anomalis:anomaly_pdf' anomaly.id %}" class="btn btn-primary btn-sm">
        <i class="fas fa-file-pdf"></i> دانلود PDF
    </a>
</div>
                                                            <!--end::Nav-->
                                                            <!--begin::separator-->
                                                            <div class="separator separator-solid mb-1"></div>
                                                            <!--end::separator-->
                                                            <!--begin::نظرات-->
                                                            {% load crispy_forms_tags %}

                                                            <!-- نظرات -->
                                                            <div id="kt_social_feeds_comments_1" class="collapse show">
                                                                <!-- Comment -->
                                                                {% for comment in comments %}
                                                                    <div class="d-flex pt-6 comment-box">
                                                                        <!-- Avatar -->
                                                                    {% if comment.user.image %}
                                                                        <div class="symbol me-5">
                                                                            <img src="{{ comment.user.image.url }}" alt="آواتار" />
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="symbol me-5">
                                                                            <img src="{% static 'assets/media/avatars/blank.png' %}" alt="آواتار" />
                                                                        </div>
                                                                    {% endif %}
                                                                        <!-- Wrapper -->
                                                                        <div class="d-flex flex-column flex-row-fluid">
                                                                            <!-- Info -->
                                                                            <div class="d-flex align-items-center flex-wrap mb-0">
                                                                                <!-- Name -->
                                                                                <a href="#" class="text-gray-800 text-hover-primary fw-bold me-6">{{ comment.user }}</a>
                                                                                <!-- Date -->
                                                                                <span class="text-gray-500 fw-semibold fs-7 me-5">{{ comment.created_at|timesince }} قبل</span>
                                                                                <!-- Reply button -->
                                                                                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#reply-form-{{ comment.id }}">
                                                                                    پاسخ
                                                                                </button>
                                                                            </div>
                                                                            <!-- Text -->
                                                                            <span class="text-gray-800 fs-7 fw-normal pt-1">{{ comment.comment }}</span>

                                                                            <!-- Form for reply -->
                                                                            <div id="reply-form-{{ comment.id }}" class="collapse mt-2 reply-box">
                                                                                <form method="POST" action="{% url 'anomalis:anomaly_detail' anomaly.pk %}">
                                                                                    {% csrf_token %}
                                                                                    <textarea class="form-control" name="comment" placeholder="نوشتن پاسخ شما..." rows="2"></textarea>
                                                                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                                                                    <button type="submit" class="btn btn-primary mt-2">ارسال پاسخ</button>
                                                                                </form>
                                                                            </div>

                                                                            <!-- نمایش پاسخ‌ها -->
                                                                            {% for reply in comment.replies.all %}
                                                                                <div class="d-flex pt-6 ms-5">
                                                                                    <!-- Avatar -->
                                                                                    <div class="symbol me-5">
                                                                                        <img src="{{ reply.user.image.url }}" alt="آواتار" />
                                                                                    </div>
                                                                                    <!-- Wrapper -->
                                                                                    <div class="d-flex flex-column flex-row-fluid">
                                                                                        <!-- Info -->
                                                                                        <div class="d-flex align-items-center flex-wrap mb-0">
                                                                                            <!-- Name -->
                                                                                            <a href="#" class="text-gray-800 text-hover-primary fw-bold me-6">{{ reply.user }}</a>
                                                                                            <!-- Date -->
                                                                                            <span class="text-gray-500 fw-semibold fs-7 me-5">{{ reply.created_at|timesince }} قبل</span>
                                                                                        </div>
                                                                                        <!-- Text -->
                                                                                        <span class="text-gray-800 fs-7 fw-normal pt-1">{{ reply.comment }}</span>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <div class="card-footer pt-0">
                                                                <!--begin::Info-->
                                                                <div class="mb-6">
                                                                    <!--begin::separator-->
                                                                    <div class="separator separator-solid"></div>
                                                                    <!--end::separator-->
                                                                    <!--begin::Nav-->

                                                                    <!--end::Nav-->
                                                                    <!--begin::separator-->
                                                                    <div class="separator separator-solid mb-1"></div>
                                                                    <!-- فرم ارسال کامنت جدید -->
                                                                    <h3>ارسال کامنت جدید:</h3>
                                                                    <div class="d-flex align-items-center mt-6">
                                                                        <!-- Avatar نویسنده -->
                                                                        {% if userprofile.image and userprofile.image.url %}
                                                                        <div class="symbol me-3">
                                                                            <img src="{{ userprofile.image.url }}" alt="آواتار" />
                                                                        </div>
                                                                        {% else %}
                                                                        <div class="symbol me-3">
                                                                            <img src="{% static 'assets/media/avatars/blank.png' %}" alt="آواتار" />
                                                                        </div>
                                                                        {% endif %}
                                                                        <!-- گروه ورودی -->
                                                                        <div class="position-relative w-100">
                                                                            <form method="POST" action="{% url 'anomalis:anomaly_detail' anomaly.pk %}">
                                                                                {% csrf_token %}
                                                                                <textarea class="form-control" name="comment" placeholder="نوشتن نظر شما..." rows="3"></textarea>
                                                                                <button type="submit" class="btn btn-primary mt-2">ارسال</button>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!--end::Collapse-->
                                                            </div>

                                                        </div>

                                                        <!--end::کارت body-->
                                                        <!--begin::کارت footer-->



                                                        <!--end::کارت footer-->
                                                    </div>
                                                    <!--end::کارت-->

                                                </div>
                                                <!--end::Posts-->
                                            </div>
                                            <!--end::Content-->
                                            <!--begin::End sidebar-->



                                            <!--end::End sidebar-->
                                        </div>
                                        <!--end::سوشیال - تغذیه-->
                                    </div>
                                    <!--end::Content container-->
                                </div>
                                <!--end::Content-->
                            </div>
                            <!--end::Content wrapper-->
                            <!--begin::Footer-->
                            {% include 'footer.html' %}
                            <!--end::Footer-->
                        </div>
                        <!--end:::اصلی-->
                    </div>
                    <!--end::Wrapper-->
                </div>
                <!--end::Page-->
            </div>
            <!--end::اپلیکیشن-->
            <!--begin::کشوs-->

            <!--begin::چت drawer-->
            <div id="kt_drawer_chat" class="bg-body" data-kt-drawer="true" data-kt-drawer-name="chat" data-kt-drawer-activate="true" data-kt-drawer-overlay="true" data-kt-drawer-width="{default:'300px', 'md': '500px'}" data-kt-drawer-direction="end" data-kt-drawer-toggle="#kt_drawer_chat_toggle" data-kt-drawer-close="#kt_drawer_chat_close">
                <!--begin::Messenger-->

                {% include 'notification.html' %}

                <!--end::Messenger-->
            </div>
            <!--end::چت drawer-->


{% endblock %}